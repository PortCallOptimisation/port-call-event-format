# Pronto event model

The pronto event model is an implementation of the funtional definitions for Nautical Port Information Standard (NPIS) 5.2.

This specification is in active development, and comments from the port community are welcome.


## Mapping between EPCIS Events and Pronto events

For an extensive compatibility overview, see the `Compatibility with GS1 EPCIS` section.

| Definition              | EPCISEvent path       | ProntoEvent path     |
| ----------------------- | ----------------------|----------------------|
| WHAT                    | `/epcList`            | `/ship`              |
| WHEN                    | `/eventTime`, `/eventTimeZoneOffset` | `/eventTime`         |
| WHERE                   | `/bizLocation`        | `/location`          |
| WHY                     | `/bizStep`, `/action` | `/eventType`, `/context` | 
| Event Id                | `/eventID`            | `/uuid`              |
| Record time             | `/recordTime`         | `/recordTime`        |

# Event v3 format

This spec describes the JSON serialization of Pronto events.
It is written in valid [Typescript](https://www.typescriptlang.org/) and human-readable.
For machine validation an equivalent JSON Schema is available.

```ts

interface IEvent {
    /** UUID identifying the event */
    uuid : UUID
    /** Follows semantic versioning, see https://semver.org */
    version : "3.1.0"
    /** System creating the event, unique within participants */
    source: string
    eventType : EventType
    /** Time at which the event was created */
    recordTime : ISO8601DateTime
    /** Time at which the event occured/will occur. The meaning of this should be interperted according to eventType */
    eventTime: ISO8601DateTime
    ship : IShip
    port : UNLOCODE
    portcallId ?: LocalPortcallId
    location ?: IEventLocation
    context ?: IEventContext
}

/** A ISO 8601 compatible date time with timezone
 * Follows YYYY-MM-DDThh:mm:ssTZD as defined in https://www.w3.org/TR/NOTE-datetime
 * Example "2017-09-01T12:00:12Z"
 * WARNING: this spec allows any ISO 8601 timezone offset (e.g. +02:00), while the nautical port information standard only allows the Z timezone
 * This might get changed either in this spec or in the nautical port information standard
 * We recommend writing only events in zulu time, but reading events with any offset
 * @TJS-format date-time
 */
type ISO8601DateTime = string

/** A Universally Unique Identifier for the event
  * Generated by the event creator
  * @pattern ^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$
  */
type UUID = string

/** A UN/LOCODE designating a port
 * @pattern ^[A-Z]{2}[A-Z2-9]{3}$
 * @example "NLRTM"
 */
type UNLOCODE = string

/** A local port call identifier issued by the port authority or an organisation authorized by the port authority
 * Must be prefixed by the UNLOCODE of the issuing port
 * Allowed characters in the identifier: a-z and A-Z (basic latin block letters), 0-9 (basic latin block digits), - (U+002D) and _ (U+005F)
 * @pattern ^[A-Z]{2}[A-Z2-9]{3}[a-zA-Z0-9\-_]+$
 * @example NLRTM17123456 is a portcall at port NLRTM, and was designated as call number 17123456 by the NLRTM port authority
 */
type LocalPortcallId = string

/** Bundles identifiers of a ship, but not information about the ship
 * At least an IMO, ENI or MMSI must be provided, with IMO being preferred over ENI, and ENI being preferred over MMSI
 * @minProperties 1
 */
interface IShip {
   imo ?: IMO
   eni ?: ENI
   mmsi ?: MMSI
   /** Name is informative only */
   name ?: string
}

/** International Maritime Organization (IMO) ship reference number
 * @pattern ^[0-9]{7}$
 */
type IMO = string

/** European Number of Identification (ENI) ship reference number
 * @pattern ^[0-9]{8}$
 */
type ENI = string

/** Maritime Mobile Service Identity, corresponding to the AIS transponder of the ship
 * @pattern ^[0-9]{9}$
 */
type MMSI = string

/** Identifies a physical location at which the event will take place */
interface IEventLocation {
    type: EventLocationType
    gln ?: GLN
    glnExtension ?: GLNExtension
    /** In case GLN is present, name is informative only
     * To provide a transition period to allow the introduction of GLNs in port, events are not required to have GLN in v3.
     * In this case, name MUST be unique per source system and consumers are allowed to link the name to locations in their master data
     */
    name ?: string
}

/** Global Location Number identifying a physical location
 * @see the GLN Specification: https://www.gs1.org/gln
 * @pattern ^[0-9]{13}$
 */
type GLN = string

/** GLN Extension component, identifying a physical sublocation of a location
 * @see AI 254: https://www.gs1.org/sites/default/files/docs/barcodes/GS1_General_Specifications.pdf
 * @pattern ^[0-9]{1,20}$
 */
type GLNExtension = string

/** EventContext is a key-value object in which users are allowed to put custom keys for any purposes
 * The following keys have pre-defined meanings within the spec
 * Keys in this object are always optional
 */
interface IEventContext {
    /** Used in combination with port.xxx.portAuthority to convey whether the port authority has given clearance for the ship to enter the port */
    clearance ?: boolean
    /** Used in combination with eta vessel or distanceToPort.at.vessel events, to inform how far away the vessel currently is */
    distanceToLocationNM ?: number
    /** Actual (reported) vessel draught in meters, real number */
    draught ?: number
    /** Mooring information, associated with berth events */
    mooring ?: {
      /** Bollard at the fore of the ship
       * Bollards are preferably integers, but some ports use fractional bollard numbers
       */
      bollardFore: number,
      /** Bollard at the aft of the ship */
      bollardAft: number,
      /** True if the ship is doulbe banked, there is a ship in between it and the berth */
      doubleBanked ?: boolean,
      /** Mooring orientation */
      orientation ?: "Port" | "Starboard"
    }
    /** The ship associated with a service event, e.g. the bunkers that will provide the bunker fuel */
    serviceShip ?: IShip
    /** The number of service ships, for when the specific service ships are not known yet
      * @minimum 0
      */
    serviceShipNumber ?: number
    movementId ?: MovementId
    berthVisitId ?: BerthVisitId
    serviceId ?: ServiceId
}

/** Identifies a movement, which is a ship traveling from one location to another inside a portcall
 * @see movement id spec
 * @pattern ^MID-[A-Z_]+-[A-Z_]+$
 */ 
type MovementId = string

/** Identifier a berth visit, which is a ship being alongside a single berth
 * @see berth visit id spec
 * @pattern ^BID-[A-Z_]+-[A-Z_]+$
 */ 
type BerthVisitId = string

/** Identifies a single service activity, like a bunker activity
 * @see service id spec
 * @pattern ^SID-[A-Z_]+-[A-Z_]+$
 */ 
type ServiceId = string

/** Designates the type of events
 * The format is a string composed of 3 parts, separated by a dot: PortActivity.TimeType.EventParty
 * Not all combinations are valid, they are restricted to the following specified event types
 */
type EventType = 
    "anchorArea.ata.vessel" |
    "anchorArea.atd.vessel" |
    "berth.ata.portAuthority" |
    "berth.ata.terminal" |
    "berth.ata.vessel" |
    "berth.atd.portAuthority" |
    "berth.atd.terminal" |
    "berth.atd.vessel" |
    "berth.cancel.agent" |
    "berth.cancel.portAuthority" |
    "berth.cancel.terminal" |
    "berth.eta.agent" |
    "berth.eta.pilot" |
    "berth.eta.portAuthority" |
    "berth.etd.agent" |
    "berth.etd.pilot" |
    "berth.etd.terminal" |
    "berth.pta.terminal" |
    "berth.ptd.portAuthority" |
    "berth.ptd.terminal" |
    "bunkerPW.atc.vessel" |
    "bunkerPW.ats.vessel" |
    "bunkerService.atc.bunkerService" |
    "bunkerService.atc.portAuthority" |
    "bunkerService.atc.vessel" |
    "bunkerService.ats.bunkerService" |
    "bunkerService.ats.portAuthority" |
    "bunkerService.ats.vessel" |
    "bunkerService.cancel.bunkerService" |
    "bunkerService.cancel.portAuthority" |
    "bunkerService.etc.bunkerService" |
    "bunkerService.ets.bunkerService" |
    "cargoOperations.atc.terminal" |
    "cargoOperations.ats.terminal" |
    "cargoOperations.etc.terminal" |
    "cargoOperations.ets.terminal" |
    "customs.atc.vessel" |
    "customs.ats.vessel" |
    "fairway.ata.vessel" |
    "firstLineReleased.at.linesmen" |
    "firstLineReleased.at.vessel" |
    "firstLineSecured.at.linesmen" |
    "firstLineSecured.at.vessel" |
    "floatingCrane.atc.vessel" |
    "floatingCrane.ats.vessel" |
    "immigration.atc.vessel" |
    "immigration.ats.vessel" |
    "lastLineReleased.at.linesmen" |
    "lastLineReleased.at.vessel" |
    "lastLineSecured.at.linesmen" |
    "lastLineSecured.at.vessel" |
    "pilotBoardingPlace.ata.vessel" |
    "pilotBoardingPlace.atd.vessel" |
    "pilotBoardingPlace.eta.agent" |
    "pilotBoardingPlace.eta.derived" |
    "pilotBoardingPlace.eta.pilot" |
    "pilotBoardingPlace.eta.portAuthority" |
    "pilotBoardingPlace.eta.predictor" |
    "pilotBoardingPlace.eta.vessel" |
    "pilotBoardingPlace.etd.predictor" |
    "pilotBoardingPlace.pta.portAuthority" |
    "pilotDisembarked.at.pilot" |
    "pilotDisembarked.at.vessel" |
    "pilotOnBoard.at.pilot" |
    "pilotOnBoard.at.vessel" |
    "port.ata.vessel" |
    "port.atd.vessel" |
    "port.cancel.agent" |
    "port.declare.portAuthority" |
    "portAuthority.atc.vessel" |
    "portAuthority.ats.vessel" |
    "portBasin.ata.vessel" |
    "provision.atc.vessel" |
    "provision.ats.vessel" |
    "slops.atc.vessel" |
    "slops.ats.vessel" |
    "tender.atc.vessel" |
    "tender.ats.vessel" |
    "vtsArea.ata.vessel" |
    "vtsArea.atd.vessel" |
    "waste.atc.vessel" |
    "waste.ats.vessel"

/** Specifies the type of location */
type EventLocationType =
    "anchorArea" |
    "approachArea" |
    "berth" |
    "fairway" |
    "pilotBoardingPlace" |
    "port" |
    "portBasin" |
    "tugArea"

/** Specifies the activity of the port call process*/
type PortActivity =
    "anchorArea" |
    "approachArea" |
    "barge" |
    "berth" |
    "bunkerPW" | // Bunkers Potable Water
    "bunkerService" |
    "cargoOperations" |
    "customs" |
    "distanceToPort" |
    "fairway" |
    "firstLineReleased" |
    "firstLineSecured" |
    "floatingCrane" |
    "immigration" |
    "lastLineReleased" |
    "lastLineSecured" |
    "pilotBoardingPlace" |
    "pilotDisembarked" |
    "pilotOnBoard" |
    "port" |
    "portAuthority " | // Different from the port authority party, this activity defines a port authority visit to the vessel
    "portBasin" |
    "provision" |
    "slops" |
    "tender" |
    "vtsArea" |
    "waste"

/** Event time type
 * declare is a special type to allow meta-information without an event time
 * cancel is a special type to signify a cancelled activity
 */
type TimeType =
    "at" |
    "ata" |
    "atc" |
    "atd" |
    "ats" |
    "cancel" |
    "declare" |
    "et" |
    "eta" |
    "etc" |
    "etd" |
    "ets" |
    "pta" |
    "ptd"
    
type EventParty =
    "agent" |
    "bunkerService" |
    "linesmen" |
    "pilot" |
    "portAuthority" |
    "terminal" |
    "tugService"
```

## MovementId, BerthVisitId and ServiceId

The event system allows for three additional identifiers in addition to portcall id's:
* Movement identifier: this identifies a movement, which is a ship traveling from one location to another inside a portcall
* Berth visit identifier: this identifier a berth visit, which is a ship being alongside a single berth
* Service identifier: this identifies a single service like bunkering

#### Justification

Consider the following events: <br />
`ETA BERTH - IMO 1 - Berth A - 12:00:00` <br />
`ETA BERTH - IMO 1 - Berth B - 14:00:00`

Purely from these events one cannot distinguish the following scenario's:
* The ship was scheduled to go to Berth A at 12:00, but instead is now scheduled to go to Berth B at 14:00
* The ship will got to Berth A at 12:00, and afterwards go to Berth B at 14:00

Similar ambiguity exists for service events (which completion event is linked to which start event?)

Note that these ambiguities usually do not exist with actuals, as they normally never will be updated and can matched on event time.

#### Format

| ID                      | Format              |
| ----------------------- | --------------------|
| Movement identifier     | `MID-{SYSTEM}-{ID}` |
| Berth visit identifier  | `BID-{SYSTEM}-{ID}` |
| Service identifier      | `SID-{SYSTEM}-{ID}` |

`{SYSTEM}` must be replaced by a string consisting of alphanumeric characters or an underscore (`[A-Z0-9_]`) of which can reasonably be assumed that it globally uniquely identifies the system sending events.

`{ID}` must be replaced by a string consisting of of alphanumeric characters or an underscore (`[A-Z0-9_]`) which is unique for that system.

#### Requirements

An event MUST NOT contain both a movement and berth visit identifier <br />
A system MUST NOT use both movement and berth visit identifiers, it can only send one type in its events <br />
A system SHOULD prefer movement identifiers over berth visit identifiers, unless it only sends events about berth activities <br />
An event belonging to a berth visit activity with a movement identifier MUST be interpreted as belonging to the berth visit following that movement <br />
A system MUST use the same berth visit, movement or service identifier if it sends new events about the same activity, unless that identifier was cancelled in case it MUST create a new one. <br />
A system MUST NOT re-use identifiers <br />
A system MAY omit a movement or berthvisit identifier if a portcall only has a single berthvisit and two movements (an inbound and outbound movement) <br />
A system SHOULD NOT send new events with an identifier it previously cancelled, since those events will be considered part of the now cancelled activity. <br />
A system MAY omit berth visit and movement identifiers for actual events <br />


# Compatibility with GS1 EPCIS 1.2

The [GS1 EPCIS standard](https://www.gs1.org/epcis) covers event exchanges in the logistics sector.
Specifically, this specification has overlap with EPCIS 1.2 Section 7.4: the event types module.

The Pronto model does not use the EPCIS event format, because the format is not designed to handle **estimated** events. 
It can only describe **actual** events, such as captured by a barcode or NFC scanner, or as emitted by the AIS transponder of a ship.
A Pronto *actual* event can always be translated to a EPCIS event and vice-versa.
If in a future EPCIS standard estimate events will be accomodated, in this case Pronto event can be translated 1 on 1 to EPCIS events and vice-versa.

See the `Mapping between EPCIS Events and Pronto events` section for a mapping of event fields.

#### WHAT, Event subject

Within Pronto, the what dimension is always a ship identified by an IMO or ENI number and/or MMSI.
Within EPCIS, a list of identifiers in URN format.

The following private URN's are currently used:

```
urn:x-imo:<IMO number>
urn:x-eni:<ENI number>
urn:x-mmsi:<MMSI number>
```

Note: GS1 [is currently working on incorporating IMO numbers into the EPC namespace](https://www.gs1.org/sites/default/files/gs1standards_in-maritime.pdf).
When this is complete, this namespace is preferred.

#### WHEN, Event Time

The event time definition in Pronto events is compatible with the EPCIS definition.

The ISO8601 format is slightly different, EPCIS and NPIS specify `YYYY-MM-DDThh:mm:ssZ`, while Pronto uses `YYYY-MM-DDThh:mm:ssTZD` (which allows non GMT timezones)

This will likely be changed in a future version of the pronto event spec.

#### WHERE, Event location

If a pronto event uses GLN's, it is compatible with EPCIS.
Currently not all ports have GLN's defined for their locations.

EPCIS uses the `sgln` URN namespace to encode a GLN and GLN Extension, while a Pronto event has two separate fields.

#### WHY, Event business context

EPCIS requires businesses to create a common business vocabulary (CVB).
GS1 is currently creating this CVB based on NPIS.
In the mean time, Pronto encodes event types in the `x-pronto` URN scheme:

`urn:x-pronto:<eventType>`, for example `urn:x-pronto:berth.eta.vessel`

Fields in an `context` should be added as fields to the Event when converting to EPCIS.

#### Other fields

##### Event ID

The EPCIS and Pronto definition of event id is identical. EPCIS encodes UUID's in the `uuid` URN namespace, while pronto only uses the UUID itself.

##### Record time

The EPCIS and Pronto definition of event record time is identical. See event time for a note on the ISO8601 format used.

# Future work

Several parties are using additional events which follow, but these have not been standarized yet:

* Tug events: Tug Stand By & Ready to Assist and Tugs Dismissed
* Estimate service events
* Whether service events should be one per service ship (`serviceShip`) or one per service activity (`serviceShips`)
* Service information like amount of bunker fuel pumped
* Events predicted on historical information or derived from other events
* Agent, Carrier, and schedule information
* Several NPIS events do not have an event type yet: Gangway secured, Gangway up, All Fast, All Clear, Safe Access to Shore Open, Safe Access to Shore closed

# Changes from Event v2

* Removed `mooringService` party
* Removed `port-1` and `port-2` events
* Removed `ReportNumber` and `Clearance` time types, both are replaced with `Declare` (i.e. events containing some information but not a timestamp)
* `tugArea` events were removed
* `120nm.ata.vessel` and related events were changed to `distanceToPort.ata.vessel` events
* `version` field was added to events
* Berthvisit, Movement and service id's have new formats
